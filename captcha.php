<?php
function generateCaptcha() {
    // Generate the captcha code and image
    // ...

    $width = 200;
    $height = 50;
    $fontFile = __DIR__ . '/arial.ttf';
    $fontSize = 24;
    
    $image = imagecreatetruecolor($width, $height);
    $bgColor = imagecolorallocate($image, 255, 255, 255);
    imagefill($image, 0, 0, $bgColor);
    
    // Generate random noise
    $noiseColor = imagecolorallocate($image, 0, 0, 0);
    for ($i = 0; $i < $width; $i++) {
        for ($j = 0; $j < $height; $j++) {
            if (rand(0, 100) < 25) { // 10% chance of adding noise
                imagesetpixel($image, $i, $j, $noiseColor);
            }
        }
    }
    
    // Generate random string
    $captchaLength = 6;
    $captchaChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    $captchaString = '';
    for ($i = 0; $i < $captchaLength; $i++) {
        $captchaString .= $captchaChars[rand(0, strlen($captchaChars) - 1)];
    }
    
    // Add text to image
    $textColor = imagecolorallocate($image, 0, 0, 0);
    $x = $width / $captchaLength;
    for ($i = 0; $i < $captchaLength; $i++) {
        $angle = rand(-15, 15);
        imagettftext($image, $fontSize, $angle, $x * $i + rand(5, 10), rand($fontSize, $height - 10), $textColor, $fontFile, $captchaString[$i]);
    }
    ob_start();
    imagepng($image);
    $imageString = ob_get_clean();
    
    return [
        'code' => $captchaString,
        'image' => base64_encode($imageString),
    ];
}
